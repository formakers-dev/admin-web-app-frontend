<template>
  <div class="test-register">
    <h1 class="title">🎮 게임 테스트 등록하기</h1>
    <h2 class="subtitle">
      게임 테스트를 좀 더 편하게 등록하고 싶은 모두의 염원이 만들어낸 페이지 🤗
    </h2>
    <br/>

    <div class="box">
      <div class="subtitle"><strong>테스트 기본 정보</strong></div>
      <br/>
      <div class="columns box">
        <b-field class="column" label="오픈 날짜 (openDate) *">
          <b-field style="padding-left: 10px; align-items: center">
            <b-datepicker v-model="betaTest.openDate"
                          style="padding-right: 10px"
                          placeholder="오픈할 날짜를 선택하세요"
                          icon="calendar-today"
                          mobile-native="true"
                          editable>
            </b-datepicker>
            <b-timepicker v-model="betaTest.openDate"
                          style="padding-right: 10px"
                          placeholder="오픈할 시각을 선택하세요"
                          icon="clock"
                          mobile-native="true"
                          editable>
            </b-timepicker>
          </b-field>
        </b-field>

        <br/>

        <b-field class="column" label="종료 날짜 (closeDate) *">
          <b-field style="padding-left: 10px; align-items: center">
            <b-datepicker v-model="betaTest.closeDate"
                          style="padding-right: 10px"
                          placeholder="종료할 날짜를 선택하세요"
                          icon="calendar-today"
                          mobile-native="true"
                          editable>
            </b-datepicker>
            <b-timepicker v-model="betaTest.closeDate"
                          style="padding-right: 10px"
                          placeholder="종료할 시각을 선택하세요"
                          icon="clock"
                          mobile-native="true"
                          editable>
            </b-timepicker>
          </b-field>
        </b-field>
      </div>
      <br/>

      <b-field label="제목 (title) *">
        <b-input v-model="betaTest.title"></b-input>
      </b-field>

      <br/>

      <b-field label="설명 (description)">
        <b-input type="textarea" v-model="betaTest.description"></b-input>
      </b-field>

      <br/>

      <b-field label="태그 (tags) *">
        <b-taginput
          v-model="betaTest.tags"
          ellipsis
          icon="label"
          placeholder="태그를 추가하세요">
        </b-taginput>
      </b-field>

      <br/>

      <b-field label="목적 (purpose)">
        <b-input v-model="betaTest.purpose"></b-input>
      </b-field>

      <br/>
      <div class="box">
        <div class="subtitle"><strong>의뢰 게임 정보</strong></div>
        <div class="columns">
          <b-field class="column" label="대표 이미지 URL (overviewImageUrl) *">
            <p>
              메인화면에서 보여지는 커버 이미지 입니다.
              <b-input v-model="betaTest.overviewImageUrl"
                       placeholder="https://i.imgur.com/NBfLCwq.png"></b-input>
              <br/>
              <img style="width: 500px" v-bind:src="betaTest.overviewImageUrl" alt="대표 이미지가 보여집니다"/>
            </p>
          </b-field>

          <b-field class="column" label="앱 아이콘 (iconImageUrl) *">
            <p>
              배너 클릭시 보여질 디테일 화면 입니다.
              <b-input v-model="betaTest.iconImageUrl"
                       placeholder="https://i.imgur.com/NBfLCwq.png"></b-input>
              <br/>
              <img style="width: 150px" v-bind:src="betaTest.iconImageUrl" alt="앱 아이콘이 보여집니다"/>
            </p>
          </b-field>
        </div>
      </div>
      <br/>

      <div class="box">
        <div class="subtitle"><strong>테스트 종류</strong></div>

        <b-field style="padding-bottom: 20px">
          <b-radio-button v-model="testType"
                          native-value="default"
                          type="is-black">
            <span>자유선택</span>
          </b-radio-button>
          <b-radio-button v-model="testType"
                          native-value="simple"
                          type="is-black">
            <span>심플</span>
          </b-radio-button>
          <b-radio-button v-model="testType"
                          native-value="level2"
                          type="is-black">
            <span>2단계</span>
          </b-radio-button>
          <b-radio-button v-model="testType"
                          native-value="level3"
                          type="is-black">
            <span>3단계</span>
          </b-radio-button>
        </b-field>

        <div class="box">
          <div>
            <div class="subtitle"><strong>리워드 (reward) *</strong></div>
            <button class="button is-black is-small" v-on:click="addRewardCard"><b>추가</b></button>
          </div>
          <br/>
          <div class="columns is-multiline">
            <RewardItem class="padding-right-10 padding-bottom-10"
                        v-for="reward in betaTest.rewards.list"
                        v-bind:key="reward"
                        v-bind:reward="reward"
                        v-on:remove-reward-item="removeRewardCard"/>
          </div>
        </div>

        <br/>

        <div class="box">
          <div>
            <div class="subtitle"><strong>미션 (missions) *</strong></div>
            <button class="button is-black is-small" v-on:click="addMissionCard"><b>추가</b></button>
          </div>
          <br/>
          <div class="columns is-multiline">
            <Mission class="padding-right-10 padding-bottom-10"
                     v-for="mission in betaTest.missions"
                     v-bind:key="mission"
                     v-bind:mission="mission"
                     v-on:remove-mission="removeMissionCard"
                     v-on:update-mission-title="updateMissionTitle"/>
          </div>
        </div>
      </div>

      <br/>

      <div class="box">
        <div class="subtitle"><strong>테스트 진행 상태별 문구 (progressText) *</strong></div>
        <br/>
        <b-field label="참여 전 (ready) *">
          <b-input v-model="betaTest.progressText.ready"
                   placeholder="밑져야 본전! 재미있어 보인다면 참여해 보세요."></b-input>
        </b-field>
        <b-field label="참여 중 (doing) *">
          <b-input v-model="betaTest.progressText.doing"
                   placeholder="당신을 기다리고 있었어요! 이어서 참여해볼까요?"></b-input>
        </b-field>
        <b-field label="참여 완료 (done) *">
          <b-input v-model="betaTest.progressText.done"
                   placeholder="굿! 훌륭해요! 마감 후 테스터 시상식이 열릴거에요."></b-input>
        </b-field>
      </div>

      <br/>

      <b-switch v-model="isTargetToFomesMebers">
        해당 테스트를 <strong class="has-text-primary">포메이커스 팀원들</strong>에게 보여지게 하기!
      </b-switch>

      <br/>
      <br/>
      <div class="buttons are-large">
        <button class="button is-primary is-fullwidth"
                v-on:click="registerBetaTest"><b>등록</b></button>
      </div>

      <br/>
    </div>

    <br/>
    <b-field v-if="result" label="Log">
      <b-message class="white-space-pre">{{ JSON.stringify(result, null, ' ') }}</b-message>
    </b-field>
  </div>
</template>

<script>
import request from '../common/http';
import RewardItem from '../components/RewardItem.vue';
import Mission from '../components/Mission.vue';

export default {
  name: 'TestRegister',
  components: {
    RewardItem,
    Mission,
  },
  data() {
    return {
      result: '',
      isLoading: true,
      isTargetToFomesMebers: true,
      testType: 'simple',
      fomesMembersUserIds: [
        'google110897406327517511196',
        'google104451659553773678959',
        'google110241405528009969953',
        'google115909938647516500511',
      ],
      betaTest: {
        title: '',
        description: '',
        tags: [],
        purpose: '',
        overviewImageUrl: '',
        iconImageUrl: '',
        openDate: new Date(),
        closeDate: new Date(),
        rewards: {
          // minimumDelay: Number,
          list: [],
        },
        missions: [],
        progressText: {
          ready: '밑져야 본전! 재미있어 보인다면 참여해 보세요.',
          doing: '당신을 기다리고 있었어요! 이어서 참여해볼까요?',
          done: '굿! 훌륭해요! 마감 후 테스터 시상식이 열릴거에요.',
        },
        targetUserIds: [],
      },
    };
  },
  methods: {
    prepareDataToRegister() {
      if (this.isTargetToFomesMebers) {
        this.betaTest.targetUserIds.push(this.fomesMembersUserIds);
      }
    },
    registerBetaTest() {
      this.prepareDataToRegister();

      const body = this.betaTest;

      request.post('/beta-test', body)
        .then((result) => {
          this.result = result;

          if (result.status === 200) {
            this.showSuccessToast('등록 성공!');
          } else {
            this.showErrorToast('실패! 로그를 확인하시오!');
          }
        })
        .catch((err) => {
          this.result = err;
          this.showErrorToast();
        });
    },
    addRewardCard() {
      console.log('addRewardCard');
      const rewardListLength = this.betaTest.rewards.list.length;
      this.betaTest.rewards.list.push({
        order: rewardListLength > 0
          ? Number(this.betaTest.rewards.list[rewardListLength - 1].order) + 1 : 1,
        iconImageUrl: '',
        title: '',
        content: '',
      });
    },
    removeRewardCard(order) {
      console.log('removeRewardCard order', order);
      const item = this.betaTest.rewards.list.find(i => i.order === order);
      const itemIndex = this.betaTest.rewards.list.indexOf(item);
      this.betaTest.rewards.list.splice(itemIndex, 1);
    },
    addMissionCard() {
      console.log('addMissionCard');
      const missionLength = this.betaTest.missions.length;
      this.betaTest.missions.push({
        order: missionLength > 0
          ? Number(this.betaTest.missions[missionLength - 1].order) + 1 : 1,
        iconImageUrl: '',
        title: '',
        description: '',
        descriptionImageUrl: '',
        guide: '',
        item: {
          order: 1,
          type: '',
          title: '',
          actionType: '',
          action: '',
          options: '',
        },
      });
    },
    removeMissionCard(order) {
      console.log('removeMissionCard order', order);
      const item = this.betaTest.missions.find(i => i.order === order);
      const itemIndex = this.betaTest.missions.indexOf(item);
      this.betaTest.missions.splice(itemIndex, 1);
    },
    updateMissionTitle(value) {
      const item = this.betaTest.missions.find(i => i.order === value.order);
      item.title = value.title;
    },
    showSuccessToast(toastMessage) {
      this.$toast.open({
        duration: 4000,
        message: toastMessage,
        type: 'is-success',
      });
    },
    showErrorToast(toastMessage) {
      this.$toast.open({
        duration: 4000,
        message: toastMessage,
        type: 'is-danger',
      });
    },
  },
};
</script>

<style scoped>
  .test-register {
    text-align: start;
    padding: 30px;
  }

  .white-space-pre {
    white-space: pre-wrap;
  }

  .padding-0 {
    padding: 0;
  }
  .padding-left-10 {
    padding-left: 10px;
  }
  .padding-right-10 {
    padding-right: 10px;
  }
  .padding-bottom-10 {
    padding-bottom: 10px;
  }
</style>
