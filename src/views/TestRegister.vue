<template>
  <div class="test-register">
    <h1 class="title">ğŸ® ê²Œì„ í…ŒìŠ¤íŠ¸ ë“±ë¡í•˜ê¸°</h1>
    <h2 class="subtitle">
      ê²Œì„ í…ŒìŠ¤íŠ¸ë¥¼ ì¢€ ë” í¸í•˜ê²Œ ë“±ë¡í•˜ê³  ì‹¶ì€ ëª¨ë‘ì˜ ì—¼ì›ì´ ë§Œë“¤ì–´ë‚¸ í˜ì´ì§€ ğŸ¤—
    </h2>
    <br/>

    <div class="box">
      <div class="subtitle"><strong>í…ŒìŠ¤íŠ¸ ê¸°ë³¸ ì •ë³´</strong></div>
      <br/>
      <div class="columns box">
        <b-field class="column" label="ì˜¤í”ˆ ë‚ ì§œ (openDate) *">
          <b-field style="padding-left: 10px; align-items: center">
            <b-datepicker v-model="betaTest.openDate"
                          style="padding-right: 10px"
                          placeholder="ì˜¤í”ˆí•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”"
                          icon="calendar-today"
                          mobile-native="true"
                          editable>
            </b-datepicker>
            <b-timepicker v-model="betaTest.openDate"
                          style="padding-right: 10px"
                          placeholder="ì˜¤í”ˆí•  ì‹œê°ì„ ì„ íƒí•˜ì„¸ìš”"
                          icon="clock"
                          mobile-native="true"
                          editable>
            </b-timepicker>
          </b-field>
        </b-field>

        <br/>

        <b-field class="column" label="ì¢…ë£Œ ë‚ ì§œ (closeDate) *">
          <b-field style="padding-left: 10px; align-items: center">
            <b-datepicker v-model="betaTest.closeDate"
                          style="padding-right: 10px"
                          placeholder="ì¢…ë£Œí•  ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”"
                          icon="calendar-today"
                          mobile-native="true"
                          editable>
            </b-datepicker>
            <b-timepicker v-model="betaTest.closeDate"
                          style="padding-right: 10px"
                          placeholder="ì¢…ë£Œí•  ì‹œê°ì„ ì„ íƒí•˜ì„¸ìš”"
                          icon="clock"
                          mobile-native="true"
                          editable>
            </b-timepicker>
          </b-field>
        </b-field>
      </div>
      <br/>

      <b-field label="ìœ í˜• (subjectType) *">
        <b-field style="padding-bottom: 20px">
          <b-radio-button v-model="betaTest.subjectType"
                          native-value="game-test"
                          v-on:input="setSubjectType"
                          type="is-black">
            <span>ê²Œì„ í…ŒìŠ¤íŠ¸</span>
          </b-radio-button>

          <b-radio-button v-model="betaTest.subjectType"
                          native-value="fomes-test"
                          v-on:input="setSubjectType"
                          type="is-black">
            <span>í¬ë©”ìŠ¤ í…ŒìŠ¤íŠ¸</span>
          </b-radio-button>

          <b-radio-button v-model="betaTest.subjectType"
                          native-value="event"
                          v-on:input="setSubjectType"
                          type="is-black">
            <span>ì´ë²¤íŠ¸</span>
          </b-radio-button>
        </b-field>
      </b-field>

      <b-field label="í”Œëœ (plan) *" v-if="betaTest.subjectType === 'game-test'">
        <b-field style="padding-bottom: 20px">
          <b-radio-button v-model="betaTest.plan"
                          native-value="trial"
                          v-on:input="setPlan"
                          type="is-black">
            <span>Trial Plan</span>
          </b-radio-button>

          <b-radio-button v-model="betaTest.plan"
                          native-value="starter"
                          v-on:input="setPlan"
                          type="is-black">
            <span>Starter Plan</span>
          </b-radio-button>

          <b-radio-button v-model="betaTest.plan"
                          native-value="lite"
                          v-on:input="setPlan"
                          type="is-black">
            <span>Lite Plan</span>
          </b-radio-button>

          <b-radio-button v-model="betaTest.plan"
                          native-value="simple"
                          v-on:input="setPlan"
                          type="is-black">
            <span>Simple Plan</span>
          </b-radio-button>

          <b-radio-button v-model="betaTest.plan"
                          native-value="standard"
                          v-on:input="setPlan"
                          type="is-black">
            <span>Standard Plan</span>
          </b-radio-button>
        </b-field>
      </b-field>

      <b-field label="ì œëª© (title) *">
        <b-input v-model="betaTest.title"></b-input>
      </b-field>

      <br/>

      <b-field label="ì„¤ëª… (description)">
        <b-input type="textarea" v-model="betaTest.description"></b-input>
      </b-field>

      <br/>

      <b-field label="íƒœê·¸ (tags) *">
        <b-taginput
          v-model="betaTest.tags"
          ellipsis
          icon="label"
          placeholder="íƒœê·¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”">
        </b-taginput>
      </b-field>

      <br/>

      <b-field label="ëª©ì  (purpose)">
        <b-input v-model="betaTest.purpose"></b-input>
      </b-field>

      <br/>

      <b-field label="ë²„ê·¸ë¦¬í¬íŠ¸ ì„¤ë¬¸ URL (bugReport.url)">
        <b-input v-model="betaTest.bugReport.url" placeholder="https://docs.google.com/forms/d/e/1FAIpQLSfCYFte9p8faIOve6YWYQkqDXdeJLggSnucAtnIYR0TsEF8fA/viewform?usp=pp_url&entry.1223559684={email}"></b-input>
      </b-field>

      <br/>

      <div class="box">
        <div class="subtitle"><strong>ì˜ë¢° ê²Œì„ ì •ë³´</strong></div>

        <div class="columns" v-if="betaTest.subjectType === 'game-test'">
          <b-field class="column" label="í”Œë ˆì´ í•  ê²Œì„ì˜ íŒ¨í‚¤ì§€ëª… (packageName) *">
            <b-input
              v-model="packageName" ref="packageName"
              placeholder="com.formakers.fomes"></b-input>
          </b-field>
          <b-field class="column" label="â†“â†“â†“">
            <button class="button is-black is-small" v-on:click="getApp(packageName)">
              <b>appsì •ë³´ì—ì„œ ì•± ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°</b>
            </button>
          </b-field>
        </div>

        <div class="columns">
          <b-field class="column" label="ëŒ€í‘œ ì´ë¯¸ì§€ URL (coverImageUrl) *">
            <p>
              ë©”ì¸í™”ë©´ì—ì„œ ë³´ì—¬ì§€ëŠ” ì»¤ë²„ ì´ë¯¸ì§€ ì…ë‹ˆë‹¤.
              <b-input v-model="betaTest.coverImageUrl"
                       placeholder="https://i.imgur.com/NBfLCwq.png"></b-input>
              <br/>
              <img style="width: 500px" v-bind:src="betaTest.coverImageUrl" alt="ëŒ€í‘œ ì´ë¯¸ì§€ê°€ ë³´ì—¬ì§‘ë‹ˆë‹¤"/>
            </p>
          </b-field>

          <b-field class="column" label="ì•± ì•„ì´ì½˜ (iconImageUrl) *">
            <p>
              ë°°ë„ˆ í´ë¦­ì‹œ ë³´ì—¬ì§ˆ ë””í…Œì¼ í™”ë©´ ì…ë‹ˆë‹¤.
              <b-input v-model="betaTest.iconImageUrl"
                       placeholder="https://i.imgur.com/NBfLCwq.png"></b-input>
              <br/>
              <img style="width: 150px" v-bind:src="betaTest.iconImageUrl" alt="ì•± ì•„ì´ì½˜ì´ ë³´ì—¬ì§‘ë‹ˆë‹¤"/>
            </p>
          </b-field>
        </div>
      </div>
      <br/>

      <div class="box">
        <div class="subtitle"><strong>í…ŒìŠ¤íŠ¸ êµ¬ì„±</strong></div>

        <b-field style="padding-bottom: 20px">
          <b-radio-button v-model="testType"
                          native-value="default"
                          v-on:input="setTestTemplateByTestType"
                          type="is-black">
            <span>ììœ ì„ íƒ</span>
          </b-radio-button>
          <b-radio-button v-model="testType"
                          native-value="simple"
                          v-on:input="setTestTemplateByTestType"
                          type="is-black">
            <span>ê°„ë‹¨ì„¤ë¬¸í˜•</span>
          </b-radio-button>
          <b-radio-button v-model="testType"
                          native-value="normal"
                          v-on:input="setTestTemplateByTestType"
                          type="is-black">
            <span>ì¼ë°˜ì„¤ë¬¸í˜•</span>
          </b-radio-button>
          <b-radio-button v-model="testType"
                          native-value="application+simple"
                          v-on:input="setTestTemplateByTestType"
                          type="is-black">
            <span>ê°„ë‹¨ì„¤ë¬¸í˜• + ì°¸ê°€ì‹ ì²­</span>
          </b-radio-button>
          <b-radio-button v-model="testType"
                          native-value="application+normal"
                          v-on:input="setTestTemplateByTestType"
                          type="is-black">
            <span>ì¼ë°˜ì„¤ë¬¸í˜• + ì°¸ê°€ì‹ ì²­</span>
          </b-radio-button>
        </b-field>

        <div class="box">
          <div>
            <div class="subtitle"><strong>ë¦¬ì›Œë“œ (reward) *</strong></div>
            <button class="button is-black is-small" v-on:click="addRewardCard"><b>ì¶”ê°€</b></button>
          </div>
          <br/>
          <div class="columns is-multiline">
            <RewardItem class="padding-right-10 padding-bottom-10"
                        v-for="reward in betaTest.rewards.list"
                        v-bind:key="reward"
                        v-bind:reward="reward"
                        v-on:remove-reward-item="removeRewardCard"/>
          </div>
        </div>

        <br/>

        <div class="box">
          <div>
            <div class="subtitle"><strong>ë¯¸ì…˜ (missions) *</strong></div>
            <button class="button is-black is-small" v-on:click="addMissionCard"><b>ì¶”ê°€</b></button>
          </div>
          <br/>
          <div class="columns is-multiline">
            <Mission class="padding-right-10 padding-bottom-10"
                     v-for="mission in betaTest.missions"
                     v-bind:key="mission"
                     v-bind:mission="mission"
                     v-on:remove-mission="removeMissionCard"
                     v-on:update-mission-title="updateMissionTitle"/>
          </div>
        </div>
      </div>

      <br/>

      <div class="box">
        <div class="subtitle"><strong>í…ŒìŠ¤íŠ¸ ì§„í–‰ ìƒíƒœë³„ ë¬¸êµ¬ (progressText) </strong></div>
        <br/>
        <b-checkbox v-model="isCustomizedProgressText" v-on:input="initializeProgressText">
          ê¸°ë³¸ ìƒíƒœë³„ ë¬¸êµ¬ ì´ì™¸ì˜ ë¬¸êµ¬ ì¶œë ¥ì„ ì›í•˜ëŠ” ê²½ìš°ë§Œ ì²´í¬í•´ì„œ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”.
        </b-checkbox>
        <br/>

        <div v-if="isCustomizedProgressText">
          <b-field label="ì°¸ì—¬ ì „ (ready) *">
            <b-input v-model="betaTest.progressText.ready"
                     placeholder="ë°‘ì ¸ì•¼ ë³¸ì „! ì¬ë¯¸ìˆì–´ ë³´ì¸ë‹¤ë©´ ì°¸ì—¬í•´ ë³´ì„¸ìš”."></b-input>
          </b-field>
          <b-field label="ì°¸ì—¬ ì¤‘ (doing) *">
            <b-input v-model="betaTest.progressText.doing"
                     placeholder="ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆì–´ìš”! ì´ì–´ì„œ ì°¸ì—¬í•´ë³¼ê¹Œìš”?"></b-input>
          </b-field>
          <b-field label="ì°¸ì—¬ ì™„ë£Œ (done) *">
            <b-input v-model="betaTest.progressText.done"
                     placeholder="êµ¿! í›Œë¥­í•´ìš”! ë§ˆê° í›„ í…ŒìŠ¤í„° ì‹œìƒì‹ì´ ì—´ë¦´ê±°ì—ìš”."></b-input>
          </b-field>
        </div>
      </div>

      <br/>

      <b-switch v-model="isTargetToFomesMembers">
        í•´ë‹¹ í…ŒìŠ¤íŠ¸ë¥¼ <strong class="has-text-primary">í¬ë©”ì´ì»¤ìŠ¤ ê´€ë¦¬ìë“¤</strong>ì—ê²Œ ë³´ì—¬ì§€ê²Œ í•˜ê¸°! (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
      </b-switch>

      <br/>
      <br/>
      <div class="buttons are-large">
        <button class="button is-primary is-fullwidth"
                v-on:click="registerBetaTest"><b>ë“±ë¡</b></button>
      </div>

      <br/>
    </div>

    <br/>
    <b-field v-if="result" label="Log">
      <b-message class="white-space-pre">{{ JSON.stringify(result, null, ' ') }}</b-message>
    </b-field>
  </div>
</template>

<script>
import request from '../common/utils/http';
import RewardItem from '../components/RewardItem.vue';
import Mission from '../components/Mission.vue';

export default {
  name: 'TestRegister',
  components: {
    RewardItem,
    Mission,
  },
  data() {
    return {
      result: '',
      isLoading: true,
      isTargetToFomesMembers: true,
      isCustomizedProgressText: false,
      packageName: '',
      testType: 'simple',
      betaTest: {
        title: '[ê²Œì„ëª…] ê²Œì„ í…ŒìŠ¤íŠ¸',
        description: '',
        subjectType: 'game-test',
        tags: [],
        purpose: '',
        coverImageUrl: '',
        iconImageUrl: '',
        openDate: new Date(),
        closeDate: new Date(),
        rewards: {
          // minimumDelay: Number,
          list: [],
        },
        missions: [],
        status: 'test',
        bugReport: {
          url: '',
        },
      },
    };
  },
  created() {
    this.setTestTemplateByTestType();
  },
  methods: {
    prepareDataToRegister() {
      if (this.isTargetToFomesMembers) {
        this.betaTest.status = 'test';
      } else {
        delete this.betaTest.status;
      }
    },
    registerBetaTest() {
      this.prepareDataToRegister();

      const body = this.betaTest;

      request.post('/api/beta-test', body)
        .then((result) => {
          this.result = result;

          if (result.status === 200) {
            this.showSuccessToast('ë“±ë¡ ì„±ê³µ!');
          } else {
            this.showErrorToast('ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì‹œì˜¤!');
          }
        })
        .catch((err) => {
          this.result = err;
          this.showErrorToast();
        });
    },
    setSubjectType(selected) {
      console.log('setSubjectType : ', selected);

      this.betaTest.subjectType = selected;

      if (selected !== 'game-test') {
        delete this.betaTest.plan;
      }

      console.log(this.betaTest);
    },
    setPlan(selected) {
      console.log('setPlan : ', selected);

      this.betaTest.plan = selected;

      console.log(this.betaTest);
    },
    addRewardCard() {
      console.log('addRewardCard');
      const rewardListLength = this.betaTest.rewards.list.length;
      this.betaTest.rewards.list.push({
        order: rewardListLength > 0
          ? Number(this.betaTest.rewards.list[rewardListLength - 1].order) + 1 : 1,
        iconImageUrl: '',
        title: '',
        content: '',
      });
    },
    removeRewardCard(order) {
      console.log('removeRewardCard order', order);
      const item = this.betaTest.rewards.list.find(i => i.order === order);
      const itemIndex = this.betaTest.rewards.list.indexOf(item);
      this.betaTest.rewards.list.splice(itemIndex, 1);
    },
    addMissionCard() {
      console.log('addMissionCard');
      const missionLength = this.betaTest.missions.length;
      this.betaTest.missions.push({
        order: missionLength > 0
          ? Number(this.betaTest.missions[missionLength - 1].order) + 1 : 1,
        type: '',
        title: '',
        description: '',
        descriptionImageUrl: '',
        guide: '',
        actionType: '',
        action: '',
        options: '',
      });
    },
    removeMissionCard(order) {
      console.log('removeMissionCard order', order);
      const item = this.betaTest.missions.find(i => i.order === order);
      const itemIndex = this.betaTest.missions.indexOf(item);
      this.betaTest.missions.splice(itemIndex, 1);
    },
    updateMissionTitle(value) {
      const item = this.betaTest.missions.find(i => i.order === value.order);
      item.title = value.title;
    },
    getApp(packageName) {
      if (!packageName) {
        alert('ì•±ì˜ íŒ¨í‚¤ì§€ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.');
        this.$refs.packageName.focus();
        return;
      }

      request.get(`/api/apps/${packageName}`)
        .then((res) => {
          console.log(res);
          if (res.status === 200) {
            this.betaTest.iconImageUrl = res.data.iconUrl;
          } else {
            this.showErrorToast('ì‹¤íŒ¨! ë¡œê·¸ë¥¼ í™•ì¸í•˜ì‹œì˜¤!');
          }
        })
        .catch((err) => {
          this.result = err;
          this.showErrorToast();
        });
    },
    showSuccessToast(toastMessage) {
      this.$toast.open({
        duration: 4000,
        message: toastMessage,
        type: 'is-success',
      });
    },
    showErrorToast(toastMessage) {
      this.$toast.open({
        duration: 4000,
        message: toastMessage,
        type: 'is-danger',
      });
    },
    initializeProgressText(checked) {
      if (checked) {
        this.betaTest.progressText = {
          ready: 'ë°‘ì ¸ì•¼ ë³¸ì „! ì¬ë¯¸ìˆì–´ ë³´ì¸ë‹¤ë©´ ì°¸ì—¬í•´ ë³´ì„¸ìš”.',
          doing: 'ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆì–´ìš”! ì´ì–´ì„œ ì°¸ì—¬í•´ë³¼ê¹Œìš”?',
          done: 'êµ¿! í›Œë¥­í•´ìš”! ë§ˆê° í›„ í…ŒìŠ¤í„° ì‹œìƒì‹ì´ ì—´ë¦´ê±°ì—ìš”.',
        };
      } else {
        delete this.betaTest.progressText;
      }
    },
    setTestTemplateByTestType() {
      console.log('setTestTemplateByTestType: ', this.testType);

      // Set rewards
      const rewardList = [];
      switch (this.testType) {
        case 'simple':
        case 'application+simple':
          rewardList.push({
            order: rewardList.length + 1,
            iconImageUrl: 'https://i.imgur.com/ybuI732.png',
            title: 'í…ŒìŠ¤íŠ¸ ìˆ˜ì„',
            content: 'ë¬¸í™”ìƒí’ˆê¶Œ 5ì²œì› (1ëª… ì„ ì •)',
          });
          rewardList.push({
            order: rewardList.length + 1,
            iconImageUrl: 'https://i.imgur.com/btZZHRp.png',
            title: 'í…ŒìŠ¤íŠ¸ ì„±ì‹¤ìƒ',
            content: 'ë¬¸í™”ìƒí’ˆê¶Œ 1ì²œì› (20ëª… ì„ ì •)',
          });
          break;

        case 'normal':
        case 'application+normal':
          rewardList.push({
            order: rewardList.length + 1,
            iconImageUrl: 'https://i.imgur.com/ybuI732.png',
            title: 'í…ŒìŠ¤íŠ¸ ìˆ˜ì„',
            content: 'ë¬¸í™”ìƒí’ˆê¶Œ 3ë§Œì› (1ëª… ì„ ì •)',
          });
          rewardList.push({
            order: rewardList.length + 1,
            iconImageUrl: 'https://i.imgur.com/6RaZ7vI.png',
            title: 'í…ŒìŠ¤íŠ¸ ì°¨ì„',
            content: 'ë¬¸í™”ìƒí’ˆê¶Œ 5ì²œì› (5ëª… ì„ ì •)',
          });
          rewardList.push({
            order: rewardList.length + 1,
            iconImageUrl: 'https://i.imgur.com/btZZHRp.png',
            title: 'í…ŒìŠ¤íŠ¸ ì„±ì‹¤ìƒ',
            content: 'ë¬¸í™”ìƒí’ˆê¶Œ 1ì²œì› (ì°¸ì—¬ì ì „ì›)',
          });
          break;

        default: // Do nothing
      }
      this.betaTest.rewards.list = rewardList;

      // Set missions
      const missions = [];
      switch (this.testType) {
        case 'application+simple':
        case 'application+normal':
          missions.push({
            order: missions.length + 1,
            type: 'survey',
            title: 'ì°¸ì—¬ ì‹ ì²­',
            description: '[ê²Œì„ëª…] í´ë¡œì¦ˆë“œ ë² íƒ€ í…ŒìŠ¤í„° ì°¸ì—¬ ì‹ ì²­',
            descriptionImageUrl: 'https://i.imgur.com/F3EJAOs.png',
            guide: 'â€¢ ì°¸ì—¬ ì‹ ì²­ í›„ ì„¤ì¹˜ê¶Œí•œ ë¶€ì—¬ê¹Œì§€ ì•½ 1ì¼ì´ ì†Œìš”ë©ë‹ˆë‹¤.',
            actionType: '',
            action: '',
            options: ['mandatory'],
          });

        // eslint-disable-next-line no-fallthrough
        case 'simple':
        case 'normal':
          missions.push({
            order: missions.length + 1,
            type: 'play',
            title: 'ê²Œì„ í”Œë ˆì´',
            description: '[ê²Œì„ëª…] ê²Œì„ì„ í”Œë ˆì´í•´ì£¼ì„¸ìš”.(30ë¶„ ì´ìƒ ê¶Œì¥)',
            descriptionImageUrl: 'https://i.imgur.com/FDDy1WG.png',
            guide: 'â€¢ ë¯¸ì…˜ì— ì°¸ì—¬í•˜ë©´ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ ê²Œì„ ë³´í˜¸ë¥¼ ìœ„í•´ ë¬´ë‹¨ ë°°í¬ ê¸ˆì§€ì— ë™ì˜í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.',
            packageName: '',
            actionType: '',
            action: '',
            options: '',
          });
          missions.push({
            order: missions.length + 1,
            type: 'survey',
            title: 'í”Œë ˆì´ í›„ ì†Œê° ì‘ì„±',
            description: '[ê²Œì„ëª…]ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì˜ê²¬ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.',
            descriptionImageUrl: 'https://i.imgur.com/XfqTB0K.png',
            guide: 'â€¢ "ì°¸ì—¬ ì™„ë£Œ" ìƒíƒœì—ë„ ì†Œê°ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nâ€¢ ì†”ì§í•˜ê³  êµ¬ì²´ì ìœ¼ë¡œ ì˜ê²¬ì„ ì ì–´ì£¼ì‹œëŠ”ê²Œ ì œì¼ ì¤‘ìš”í•©ë‹ˆë‹¤.',
            actionType: '',
            action: '',
            options: [
              'mandatory',
              'repeatable',
            ],
          });
          break;

        default: // Do nothing
      }
      this.betaTest.missions = missions;
    },
  },
};
</script>

<style scoped>
  .test-register {
    text-align: start;
    padding: 30px;
  }

  .white-space-pre {
    white-space: pre-wrap;
  }

  .padding-0 {
    padding: 0;
  }
  .padding-left-10 {
    padding-left: 10px;
  }
  .padding-right-10 {
    padding-right: 10px;
  }
  .padding-bottom-10 {
    padding-bottom: 10px;
  }
</style>
